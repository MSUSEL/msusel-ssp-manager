name: Deploy to AKS

on:
  push:
    branches: 
      - minikube
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set environment variables
        run: |
          echo "GITHUB_USER_LOWERCASE=$(echo ${{ github.actor }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build OSCAL Processing image
        run: |
          docker build \
            -t ghcr.io/${{ env.GITHUB_USER_LOWERCASE }}/oscal-processing:latest \
            ./oscal-processing
          docker push ghcr.io/${{ env.GITHUB_USER_LOWERCASE }}/oscal-processing:latest

      - name: Build Flask image
        run: |
          docker build \
            --build-arg HOST_VOLUME_PATH="/flask" \
            -t ghcr.io/${{ env.GITHUB_USER_LOWERCASE }}/msu-ssp-manager-flask:latest \
            -f flask/Dockerfile ./flask
          docker push ghcr.io/${{ env.GITHUB_USER_LOWERCASE }}/msu-ssp-manager-flask:latest

      - name: Build React image
        run: |
          docker build \
            -t ghcr.io/${{ env.GITHUB_USER_LOWERCASE }}/msu-ssp-manager-react-app:latest \
            -f flask/react-app/Dockerfile ./flask/react-app
          docker push ghcr.io/${{ env.GITHUB_USER_LOWERCASE }}/msu-ssp-manager-react-app:latest
      - name: Set up Kubectl
        run: |
          # First create the directory
          mkdir -p $HOME/.kube
          # Then decode and write the config file
          echo "${{ secrets.KUBECONFIG_SECRET }}" | base64 -d > $HOME/.kube/config
          # Set permissions
          chmod 600 $HOME/.kube/config
          # Set environment variable
          export KUBECONFIG=$HOME/.kube/config
          # Verify the connection
          kubectl cluster-info

      - name: Deploy to AKS
        env:
          KUBECONFIG: /home/runner/.kube/config
        run: |
          # Create storage resources (with validation disabled)
          kubectl apply --validate=false -f manifests/flask-shared-pv.yaml
          kubectl apply --validate=false -f manifests/flask-pvc.yaml
          
          # Create secrets
          kubectl apply --validate=false -f manifests/flask-secrets.yaml
          
          # Create OSCAL job template - using create instead of apply for generateName
          kubectl create -f manifests/oscal-job-template.yaml --save-config || true
          
          # Deploy main applications
          kubectl apply --validate=false -f manifests/flask-deployment.yaml
          kubectl apply --validate=false -f manifests/flask-service.yaml
          kubectl apply --validate=false -f manifests/react-app-deployment.yaml
          kubectl apply --validate=false -f manifests/react-app-service.yaml
          
          # Wait for deployments
          kubectl rollout status deployment/flask
          kubectl rollout status deployment/react-app

