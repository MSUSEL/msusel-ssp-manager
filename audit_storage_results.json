{"platform":{"name":"ubuntu","release":"24.04","target_id":"d2111083-60e2-528a-8a75-14e2e2460ed3"},"profiles":[{"name":"tests from inspec.controls.audit_storage_test.rb","sha256":"7c41c1d4bfeebdceec940113d2355e864d91abd437411419829432c11f9bfaa5","title":"tests from inspec/controls/audit_storage_test.rb","supports":[],"attributes":[],"groups":[{"id":"audit_storage_test.rb","controls":["audit-storage"]}],"controls":[{"id":"audit-storage","title":"Validate Audit Storage Capacity Controls","desc":"Ensure that sufficient audit record storage capacity is allocated and configured to prevent capacity being exceeded (AU-4)","descriptions":[{"label":"default","data":"Ensure that sufficient audit record storage capacity is allocated and configured to prevent capacity being exceeded (AU-4)"}],"impact":1.0,"refs":[],"tags":{},"code":"control 'audit-storage' do\n  impact 1.0\n  title 'Validate Audit Storage Capacity Controls'\n  desc 'Ensure that sufficient audit record storage capacity is allocated and configured to prevent capacity being exceeded (AU-4)'\n\n  app_url = 'http://localhost:8000'\n  log_file_path = './logs/opa_interactions.log'\n  audit_log_path = './logs/audit.log'\n\n  # Test case 1: Verify audit storage capacity configuration\n  describe 'Audit storage capacity configuration' do\n    # Get storage capacity information\n    storage_info_response = http(\"#{app_url}/audit_storage_info\",\n                                method: 'GET',\n                                headers: { 'Content-Type' => 'application/json' })\n\n    storage_info = JSON.parse(storage_info_response.body)\n\n    it 'should have sufficient storage capacity' do\n      unless storage_info['capacity_gb'] >= storage_info['required_capacity_gb']\n        fail \"Insufficient storage capacity. Required: #{storage_info['required_capacity_gb']}GB, Allocated: #{storage_info['capacity_gb']}GB\"\n      end\n    end\n\n    it 'should have monitoring enabled' do\n      unless storage_info['monitoring_enabled'] == true\n        fail \"Storage monitoring is not enabled\"\n      end\n    end\n\n    it 'should have appropriate monitoring interval' do\n      unless storage_info['monitoring_interval_minutes'] <= 60\n        fail \"Monitoring interval too long: #{storage_info['monitoring_interval_minutes']} minutes (should be <= 60)\"\n      end\n    end\n\n    it 'should have alerts configured' do\n      unless storage_info['alerts_enabled'] == true\n        fail \"Storage alerts are not enabled\"\n      end\n    end\n\n    it 'should have appropriate warning threshold' do\n      unless storage_info['warning_threshold_percent'] <= 80\n        fail \"Warning threshold too high: #{storage_info['warning_threshold_percent']}% (should be <= 80%)\"\n      end\n    end\n\n    it 'should have appropriate critical threshold' do\n      unless storage_info['critical_threshold_percent'] <= 90\n        fail \"Critical threshold too high: #{storage_info['critical_threshold_percent']}% (should be <= 90%)\"\n      end\n    end\n\n    it 'should have alert recipients configured' do\n      unless storage_info['alert_recipients'] && storage_info['alert_recipients'].length > 0\n        fail \"No alert recipients configured\"\n      end\n    end\n  end\n\n  # Test case 2: Verify retention policy configuration\n  describe 'Audit retention policy configuration' do\n    # Get retention policy information\n    retention_info_response = http(\"#{app_url}/audit_retention_info\",\n                                  method: 'GET',\n                                  headers: { 'Content-Type' => 'application/json' })\n\n    retention_info = JSON.parse(retention_info_response.body)\n\n    it 'should have retention policy enabled' do\n      unless retention_info['retention_policy_enabled'] == true\n        fail \"Retention policy is not enabled\"\n      end\n    end\n\n    it 'should have appropriate retention period' do\n      unless retention_info['retention_period_days'] >= 180\n        fail \"Retention period too short: #{retention_info['retention_period_days']} days (should be >= 180)\"\n      end\n    end\n\n    it 'should have archiving enabled' do\n      unless retention_info['archiving_enabled'] == true\n        fail \"Archiving is not enabled\"\n      end\n    end\n  end\n\n  # Test case 3: Verify current storage usage\n  describe 'Current storage usage' do\n    # Get current storage usage\n    usage_info_response = http(\"#{app_url}/audit_storage_usage\",\n                              method: 'GET',\n                              headers: { 'Content-Type' => 'application/json' })\n\n    usage_info = JSON.parse(usage_info_response.body)\n    usage_percent = (usage_info['used_gb'].to_f / usage_info['capacity_gb'].to_f) * 100\n\n    it 'should be within acceptable limits' do\n      unless usage_percent < usage_info['critical_threshold_percent']\n        fail \"Storage usage at critical level: #{usage_percent.round(2)}% (threshold: #{usage_info['critical_threshold_percent']}%)\"\n      end\n    end\n\n    it 'should generate appropriate alerts when approaching capacity' do\n      if usage_percent >= usage_info['warning_threshold_percent'] && usage_percent < usage_info['critical_threshold_percent']\n        # Check if warning alert was generated\n        opa_log_content = file(log_file_path).content\n        unless opa_log_content.include?('storage_approaching_capacity') && opa_log_content.include?('true')\n          fail \"Warning alert not generated for storage approaching capacity\"\n        end\n      end\n    end\n\n    it 'should generate appropriate alerts when at critical capacity' do\n      if usage_percent >= usage_info['critical_threshold_percent']\n        # Check if critical alert was generated\n        opa_log_content = file(log_file_path).content\n        unless opa_log_content.include?('storage_at_critical_capacity') && opa_log_content.include?('true')\n          fail \"Critical alert not generated for storage at critical capacity\"\n        end\n      end\n    end\n  end\n\n  # Test case 4: Verify automatic actions for capacity management\n  describe 'Automatic actions for capacity management' do\n    # Get automatic actions configuration\n    actions_info_response = http(\"#{app_url}/audit_automatic_actions\",\n                                method: 'GET',\n                                headers: { 'Content-Type' => 'application/json' })\n\n    actions_info = JSON.parse(actions_info_response.body)\n\n    it 'should have automatic actions enabled' do\n      unless actions_info['automatic_actions_enabled'] == true\n        fail \"Automatic actions are not enabled\"\n      end\n    end\n\n    it 'should have at least one action configured' do\n      unless actions_info['automatic_actions'] && actions_info['automatic_actions'].length > 0\n        fail \"No automatic actions configured\"\n      end\n    end\n  end\n\n  # Test case 5: Verify OPA policy validation\n  describe 'OPA policy validation for audit storage' do\n    # Check OPA logs for audit storage validation\n    opa_log_content = file(log_file_path).content\n\n    it 'should contain audit storage validation in OPA logs' do\n      keywords = %w[audit_storage_compliant storage_capacity_sufficient storage_monitoring_configured storage_alerts_configured]\n      missing_keywords = keywords.reject { |keyword| opa_log_content.include?(keyword) }\n      \n      unless missing_keywords.empty?\n        fail \"OPA logs do not contain audit storage validation keywords: #{missing_keywords.join(', ')}\"\n      end\n    end\n  end\n\n  # Test case 6: Simulate approaching capacity and verify response\n  describe 'System response to approaching capacity' do\n    # Simulate approaching capacity\n    simulate_response = http(\"#{app_url}/simulate_storage_usage\",\n                            method: 'POST',\n                            headers: { 'Content-Type' => 'application/json' },\n                            data: { usage_percent: 75 }.to_json)\n\n    simulate_result = JSON.parse(simulate_response.body)\n\n    it 'should detect approaching capacity' do\n      unless simulate_result['storage_approaching_capacity'] == true\n        fail \"System did not detect approaching capacity\"\n      end\n    end\n\n    it 'should generate warning alert' do\n      unless simulate_result['alert_generated'] == true && simulate_result['alert_level'] == 'warning'\n        fail \"Warning alert not generated for approaching capacity\"\n      end\n    end\n  end\n\n  # Test case 7: Simulate critical capacity and verify response\n  describe 'System response to critical capacity' do\n    # Simulate critical capacity\n    simulate_response = http(\"#{app_url}/simulate_storage_usage\",\n                            method: 'POST',\n                            headers: { 'Content-Type' => 'application/json' },\n                            data: { usage_percent: 95 }.to_json)\n\n    simulate_result = JSON.parse(simulate_response.body)\n\n    it 'should detect critical capacity' do\n      unless simulate_result['storage_at_critical_capacity'] == true\n        fail \"System did not detect critical capacity\"\n      end\n    end\n\n    it 'should generate critical alert' do\n      unless simulate_result['alert_generated'] == true && simulate_result['alert_level'] == 'critical'\n        fail \"Critical alert not generated for critical capacity\"\n      end\n    end\n\n    it 'should trigger automatic actions' do\n      unless simulate_result['automatic_actions_triggered'] == true\n        fail \"Automatic actions not triggered for critical capacity\"\n      end\n    end\n  end\nend\n","source_location":{"line":1,"ref":"inspec/controls/audit_storage_test.rb"},"waiver_data":{},"results":[{"status":"passed","code_desc":"Audit storage capacity configuration should have sufficient storage capacity","run_time":0.000243995,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit storage capacity configuration"},{"status":"passed","code_desc":"Audit storage capacity configuration should have monitoring enabled","run_time":6.8097e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit storage capacity configuration"},{"status":"passed","code_desc":"Audit storage capacity configuration should have appropriate monitoring interval","run_time":5.8489e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit storage capacity configuration"},{"status":"passed","code_desc":"Audit storage capacity configuration should have alerts configured","run_time":5.0624e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit storage capacity configuration"},{"status":"passed","code_desc":"Audit storage capacity configuration should have appropriate warning threshold","run_time":4.9371e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit storage capacity configuration"},{"status":"passed","code_desc":"Audit storage capacity configuration should have appropriate critical threshold","run_time":5.1696e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit storage capacity configuration"},{"status":"passed","code_desc":"Audit storage capacity configuration should have alert recipients configured","run_time":0.000136134,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit storage capacity configuration"},{"status":"passed","code_desc":"Audit retention policy configuration should have retention policy enabled","run_time":8.2594e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit retention policy configuration"},{"status":"passed","code_desc":"Audit retention policy configuration should have appropriate retention period","run_time":6.3829e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit retention policy configuration"},{"status":"passed","code_desc":"Audit retention policy configuration should have archiving enabled","run_time":5.4491e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Audit retention policy configuration"},{"status":"passed","code_desc":"Current storage usage should be within acceptable limits","run_time":6.7335e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Current storage usage"},{"status":"passed","code_desc":"Current storage usage should generate appropriate alerts when approaching capacity","run_time":5.2688e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Current storage usage"},{"status":"passed","code_desc":"Current storage usage should generate appropriate alerts when at critical capacity","run_time":4.6977e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Current storage usage"},{"status":"passed","code_desc":"Automatic actions for capacity management should have automatic actions enabled","run_time":7.5491e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Automatic actions for capacity management"},{"status":"passed","code_desc":"Automatic actions for capacity management should have at least one action configured","run_time":0.002352428,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"Automatic actions for capacity management"},{"status":"passed","code_desc":"OPA policy validation for audit storage should contain audit storage validation in OPA logs","run_time":0.002139593,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"OPA policy validation for audit storage"},{"status":"passed","code_desc":"System response to approaching capacity should detect approaching capacity","run_time":7.8948e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"System response to approaching capacity"},{"status":"passed","code_desc":"System response to approaching capacity should generate warning alert","run_time":5.4121e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"System response to approaching capacity"},{"status":"passed","code_desc":"System response to critical capacity should detect critical capacity","run_time":8.585e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"System response to critical capacity"},{"status":"passed","code_desc":"System response to critical capacity should generate critical alert","run_time":6.9851e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"System response to critical capacity"},{"status":"passed","code_desc":"System response to critical capacity should trigger automatic actions","run_time":5.356e-05,"start_time":"2025-05-03T20:51:23-06:00","resource_class":"Object","resource_params":"[]","resource_id":"System response to critical capacity"}]}],"status":"loaded","status_message":""}],"statistics":{"duration":0.0184364},"version":"6.8.11"}